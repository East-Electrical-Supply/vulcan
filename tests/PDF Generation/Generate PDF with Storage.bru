meta {
  name: Generate PDF with Storage
  type: http
  seq: 2
}

post {
  url: {{baseUrl}}/pdf
  body: json
  auth: none
}

body:json {
  {
    "html": "PCFET0NUWVBFIGh0bWw+CjxodG1sIGxhbmc9ImVuIj4KPGhlYWQ+CiAgPG1ldGEgY2hhcnNldD0iVVRGLTgiPgogIDxtZXRhIG5hbWU9InZpZXdwb3J0IiBjb250ZW50PSJ3aWR0aD1kZXZpY2Utd2lkdGgsIGluaXRpYWwtc2NhbGU9MS4wIj4KICA8dGl0bGU+U3RvcmVkIFBERiBUZXN0PC90aXRsZT4KICA8c3R5bGU+CiAgICBib2R5IHsKICAgICAgZm9udC1mYW1pbHk6IEFyaWFsLCBzYW5zLXNlcmlmOwogICAgICBtYXJnaW46IDQwcHg7CiAgICB9CiAgICBoMSB7CiAgICAgIGNvbG9yOiAjMDA2NmNjOwogICAgfQogICAgLnN0b3JlZC1jb250ZW50IHsKICAgICAgYmFja2dyb3VuZC1jb2xvcjogI2VlZmZmZjsKICAgICAgcGFkZGluZzogMjBweDsKICAgICAgYm9yZGVyOiAycHggc29saWQgIzAwNjZjYzsKICAgICAgYm9yZGVyLXJhZGl1czogNXB4OwogICAgfQogIDwvc3R5bGU+CjwvaGVhZD4KPGJvZHk+CiAgPGgxPlN0b3JlZCBQREYgRG9jdW1lbnQ8L2gxPgogIDxkaXYgY2xhc3M9InN0b3JlZC1jb250ZW50Ij4KICAgIDxwPlRoaXMgUERGIHdpbGwgYmUgc3RvcmVkIG9uIHRoZSBzZXJ2ZXIgYW5kIGEgZG93bmxvYWQgVVJMIHJldHVybmVkLjwvcD4KICAgIDxwPlRoaXMgaXMgdXNlZnVsIGZvciBhc3luY2hyb25vdXMgUERGIGdlbmVyYXRpb24gd29ya2Zsb3dzLjwvcD4KICA8L2Rpdj4KPC9ib2R5Pgo8L2h0bWw+",
    "options": {
      "download": false
    }
  }
}

assert {
  res.status: eq 200
  res.body.success: eq true
  res.body.filename: isDefined
  res.body.downloadUrl: isDefined
  res.body.message: isDefined
}

tests {
  test("Should return success response with file details", function() {
    expect(res.getStatus()).to.equal(200);
    
    const body = res.getBody();
    expect(body.success).to.be.true;
    expect(body.filename).to.match(/^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}\.pdf$/);
    expect(body.downloadUrl).to.contain("/pdfs/");
    expect(body.downloadUrl).to.contain(body.filename);
    expect(body.message).to.contain("generated and stored successfully");
  });

  test("Should store filename for download test", function() {
    const body = res.getBody();
    bru.setVar("storedFilename", body.filename);
  });
}